# LinkedIn Selector API Documentation

This API allows you to test and update LinkedIn selectors against real profiles to ensure your scraping functionality continues to work correctly as LinkedIn's website changes.

## Features

- Verify LinkedIn selectors against a specific profile URL or the latest lead in your database
- Get detailed metrics about which selectors are working well and which need attention
- Analyze selector performance by category
- Automatically use an authenticated LinkedIn account to access profile data

## API Endpoints

### Verify Selectors

**Endpoint:** `POST /api/linkedin/selectors/verify`

This endpoint tests all LinkedIn selectors against a profile and returns health metrics for each selector.

**Request Body:**

```json
{
  "linkedinAccountId": "6123456789abcdef01234567",  // MongoDB ID of the LinkedIn account to use
  "password": "account_password",                   // Password for LinkedIn authentication
  "profileUrl": "https://www.linkedin.com/in/some-profile", // Profile URL to test against (optional if useLatestLead is true)
  "useLatestLead": false,                           // Set to true to use the most recent lead with a valid profile URL
  "proxyId": "6123456789abcdef01234568",           // Optional MongoDB ID of a proxy to use
  "outputPath": "./data/selector-metrics.json"      // Optional path to save metrics to a file
}
```

**Notes:**
- You must provide either `profileUrl` or set `useLatestLead` to true
- The `password` field is required for LinkedIn authentication
- If `useLatestLead` is true, the system will use the most recent lead in the database that has a valid LinkedIn profile URL
- Results are returned via the API response AND can optionally be saved to a file if `outputPath` is specified

**Response:**

```json
{
  "success": true,
  "message": "Selector verification completed successfully",
  "data": {
    "metrics": {
      "selector1": {
        "selector": "div.profile-name",
        "category": "Profile Name",
        "successCount": 5,
        "failureCount": 0,
        "successRate": 1.0,
        "lastText": "John Doe"
      },
      "selector2": {
        "selector": "div.old-headline-selector",
        "category": "Headline",
        "successCount": 0,
        "failureCount": 5,
        "successRate": 0.0,
        "lastText": null
      }
      // More selectors...
    },
    "summary": {
      "totalSelectors": 120,
      "workingSelectors": 98,
      "successRate": 82,
      "categories": ["Profile Name", "Headline", "Location", ...]
    },
    "profileUsed": "https://www.linkedin.com/in/some-profile"
  }
}
```

### Update Selectors

**Endpoint:** `POST /api/linkedin/selectors/update`

This endpoint analyzes previously collected selector metrics and provides recommendations for updating poor-performing selectors.

**Request Body:**

```json
{
  "metricsPath": "./data/selector-metrics.json",  // Path to the metrics file generated by verify API
  "threshold": 0.5,                               // Success rate threshold (0-1) for identifying poor selectors
  "category": "Headline",                         // Optional - focus on a specific category
  "updateSelectorFile": true,                     // Whether to update the selector file automatically
  "selectorFile": "./data/selectors.json"         // Path to the selector file to update (required if updateSelectorFile is true)
}
```

**Response:**

```json
{
  "success": true,
  "message": "Selector analysis completed successfully",
  "threshold": 0.5,
  "data": {
    "Profile Name": {
      "totalSelectors": 8,
      "goodSelectors": 6,
      "poorSelectors": 2,
      "best": {
        "selector": "div.profile-name",
        "category": "Profile Name",
        "successCount": 5,
        "failureCount": 0,
        "successRate": 1.0,
        "lastText": "John Doe"
      },
      "needsAttention": [
        {
          "selector": "h1.old-profile-name",
          "successRate": 0.2,
          "successCount": 1,
          "failureCount": 4,
          "lastText": null
        },
        {
          "selector": "div.deprecated-name-container",
          "successRate": 0.0,
          "successCount": 0,
          "failureCount": 5,
          "lastText": null
        }
      ]
    },
    // More categories...
  },
  "updates": {
    "Profile Name": {
      "bestSelector": "div.profile-name",
      "replacedSelectors": ["h1.old-profile-name", "div.deprecated-name-container"],
      "effectiveSelectors": ["div.profile-name", "h1.text-heading-xlarge"]
    }
  },
  "selectorFileUpdated": true,
  "selectorFilePath": "/path/to/selectors.json"
}
```

## Using with the Existing Postman Collection

The LinkedIn selector API endpoints have been integrated into the existing "LinkedIn Scraper API" Postman collection in a new folder called "LinkedIn Selectors".

### Setup:

1. Use the latest version of the "LinkedIn Scraper API.postman_collection.json" collection
2. Use the "LinkedIn Scraper API Environment.postman_environment.json" environment
3. Make sure the following environment variables are set:
   - `baseUrl`: Your API base URL (e.g., `http://localhost:4001`)
   - `adminToken`: Admin JWT token for authentication (required for these endpoints)
   - `linkedinAccountId`: MongoDB ID of the LinkedIn account to use
   - `linkedinAccountPass`: Password for the LinkedIn account
   - `proxyId`: MongoDB ID of a proxy to use (optional)
   - `selectorsOutputPath`: Path where selector metrics will be saved
   - `selectorThreshold`: Threshold value for identifying poor selectors (default: 0.5)

### Using the Endpoints:

1. Log in as an admin using the "Login Admin" request in the "Auth" folder
2. Look for the "LinkedIn Selectors" folder in the collection
3. Use "Verify Selectors with ProfileURL" to test against a specific LinkedIn profile
4. Use "Verify Selectors with Latest Lead" to test against the most recent lead in your database
5. Use "Update Selectors" to analyze the generated metrics file and get recommendations

### Detailed Postman Guide:

For a detailed guide on using these endpoints in Postman, refer to the `README-POSTMAN-SELECTORS.md` file in the project root. This guide provides step-by-step instructions, example workflows, and troubleshooting tips.

## Integration Notes

- These endpoints are secured with admin-only access
- The LinkedIn account needs to be properly authenticated to access profile data
- The verification process may take 1-2 minutes to complete as it tests many selectors
- Consider setting up scheduled verification (e.g., weekly) to catch LinkedIn UI changes early

## Troubleshooting

- If you encounter CAPTCHA or verification challenges, try using a different LinkedIn account
- If certain selectors consistently fail, consider examining the HTML structure of LinkedIn profiles
- Check the server logs for more detailed information about selector performance
- Use a reliable LinkedIn account that's not rate-limited or recently used for scraping

---

For detailed implementation of these APIs, see:
- `src/routes/linkedin.routes.ts` - API routes
- `src/controllers/linkedin.controller.ts` - Controller logic
- `src/services/linkedin/SelectorVerifier.ts` - Verification implementation
- `src/services/linkedin/LinkedInProfileScraper.ts` - Profile interaction logic
