# LinkedIn Selector API Documentation

This API allows you to test and update LinkedIn selectors against real profiles to ensure your scraping functionality continues to work correctly as LinkedIn's website changes.

## Features

- Verify LinkedIn selectors against a specific profile URL or the latest lead in your database
- Get detailed metrics about which selectors are working well and which need attention
- Analyze selector performance by category
- Automatically use an authenticated LinkedIn account to access profile data

## API Endpoints

### Verify Selectors

**Endpoint:** `POST /api/linkedin/selectors/verify`

This endpoint tests all LinkedIn selectors against a profile and returns health metrics for each selector.

**Request Body:**

```json
{
  "linkedinAccountId": "6123456789abcdef01234567",  // MongoDB ID of LinkedIn account
  "password": "password123",                        // LinkedIn account password
  "profileUrl": "https://www.linkedin.com/in/...",  // LinkedIn profile URL to test against (optional if useLatestLead is true)
  "useLatestLead": false,                           // Use the latest lead with a LinkedIn URL in the database (optional if profileUrl is provided)
  "proxyId": "6123456789abcdef01234568",            // MongoDB ID of proxy to use (optional)
  "outputPath": "./output/metrics.json"             // Path to save metrics to a file (optional)
}
```

**Response:**

```json
{
  "success": true,
  "message": "Selector verification completed successfully",
  "data": {
    "metrics": {
      // Metrics for each selector
      "selector1": {
        "selector": "selector1",
        "category": "Profile Header",
        "successRate": 1.0,
        "successCount": 1,
        "failureCount": 0,
        "lastText": "Text extracted by selector"
      },
      // ... more selectors
    },
    "summary": {
      "totalSelectors": 50,
      "workingSelectors": 48,
      "successRate": 96,
      "categories": ["Profile Header", "About Section", ...]
    },
    "profileUsed": "https://www.linkedin.com/in/..."
  }
}
```

### Update Selectors

**Endpoint:** `POST /api/linkedin/selectors/update`

This endpoint analyzes selector health metrics and provides recommendations for updates.

**Request Body:**

```json
{
  "metricsPath": "./output/metrics.json",      // Path to the metrics file generated by the verify endpoint (required)
  "threshold": 0.5,                            // Success rate threshold for considering a selector healthy (0-1, default: 0.5)
  "category": "Profile Header",                // Process only selectors in this category (optional)
  "category": ["Profile Header", "Experience Section"],  // Process selectors in multiple categories (optional)
  "updateSelectorFile": true,                  // Whether to update the selector file with recommendations (default: true)
  "selectorFile": "./data/selectors.json"      // Path to the selector file to update (optional, required if updateSelectorFile is true)
}
```

**Response:**

```json
{
  "success": true,
  "message": "Selector analysis completed successfully",
  "threshold": 0.5,
  "data": {
    // Results for each category
    "Profile Header": {
      "totalSelectors": 5,
      "goodSelectors": 4,
      "poorSelectors": 1,
      "best": {
        // Best performing selector in this category
        "selector": ".pv-top-card--list .text-body-medium",
        "successRate": 1.0,
        // ...
      },
      "needsAttention": [
        // Poor performing selectors
        {
          "selector": ".old-selector",
          "successRate": 0.0,
          // ...
        }
      ]
    },
    // More categories...
    "selectorFileUpdated": true,
    "selectorFilePath": "/absolute/path/to/selectors.json"
  },
  "updates": {
    // Updates applied to the selector file
    "Profile Header": {
      "bestSelector": ".pv-top-card--list .text-body-medium",
      "replacedSelectors": [".old-selector"],
      "effectiveSelectors": [".pv-top-card--list .text-body-medium", ...]
    },
    // More categories...
  }
}
```

## Usage Notes

- When using the `verify` endpoint, you must provide either `profileUrl` or `useLatestLead` (or both).
- The `verify` endpoint requires a LinkedIn account ID with valid credentials.
- The `update` endpoint analyzes the metrics file generated by the `verify` endpoint.
- The `category` parameter in the `update` endpoint can be a single string or an array of strings to process multiple categories at once.
- If no category is specified in the `update` endpoint, all categories will be processed.
- Set `updateSelectorFile` to `true` to automatically update your selectors file with recommended changes.

## Authentication

Both endpoints require admin authentication. Include the admin JWT token in the Authorization header:

```
Authorization: Bearer <adminToken>
```

## See Also

For Postman usage examples, see [README-POSTMAN-SELECTORS.md](README-POSTMAN-SELECTORS.md)

## Using with the Existing Postman Collection

The LinkedIn selector API endpoints have been integrated into the existing "LinkedIn Scraper API" Postman collection in a new folder called "LinkedIn Selectors".

### Setup:

1. Use the latest version of the "LinkedIn Scraper API.postman_collection.json" collection
2. Use the "LinkedIn Scraper API Environment.postman_environment.json" environment
3. Make sure the following environment variables are set:
   - `baseUrl`: Your API base URL (e.g., `http://localhost:4001`)
   - `adminToken`: Admin JWT token for authentication (required for these endpoints)
   - `linkedinAccountId`: MongoDB ID of the LinkedIn account to use
   - `linkedinAccountPass`: Password for the LinkedIn account
   - `proxyId`: MongoDB ID of a proxy to use (optional)
   - `selectorsOutputPath`: Path where selector metrics will be saved
   - `selectorThreshold`: Threshold value for identifying poor selectors (default: 0.5)

### Using the Endpoints:

1. Log in as an admin using the "Login Admin" request in the "Auth" folder
2. Look for the "LinkedIn Selectors" folder in the collection
3. Use "Verify Selectors with ProfileURL" to test against a specific LinkedIn profile
4. Use "Verify Selectors with Latest Lead" to test against the most recent lead in your database
5. Use "Update Selectors" to analyze the generated metrics file and get recommendations

### Detailed Postman Guide:

For a detailed guide on using these endpoints in Postman, refer to the `README-POSTMAN-SELECTORS.md` file in the project root. This guide provides step-by-step instructions, example workflows, and troubleshooting tips.

## Integration Notes

- These endpoints are secured with admin-only access
- The LinkedIn account needs to be properly authenticated to access profile data
- The verification process may take 1-2 minutes to complete as it tests many selectors
- Consider setting up scheduled verification (e.g., weekly) to catch LinkedIn UI changes early

## Troubleshooting

- If you encounter CAPTCHA or verification challenges, try using a different LinkedIn account
- If certain selectors consistently fail, consider examining the HTML structure of LinkedIn profiles
- Check the server logs for more detailed information about selector performance
- Use a reliable LinkedIn account that's not rate-limited or recently used for scraping

---

For detailed implementation of these APIs, see:
- `src/routes/linkedin.routes.ts` - API routes
- `src/controllers/linkedin.controller.ts` - Controller logic
- `src/services/linkedin/SelectorVerifier.ts` - Verification implementation
- `src/services/linkedin/LinkedInProfileScraper.ts` - Profile interaction logic
